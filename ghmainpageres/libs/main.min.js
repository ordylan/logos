"use strict";var __reflect=this&&this.__reflect||function(t,e,n){t.__class__=e,n?n.push(e):n=[e],t.__types__=t.__types__?n.concat(t.__types__):n},__extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);n.prototype=e.prototype,t.prototype=new n},__awaiter=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))(function(o,i){function a(t){try{l(r.next(t))}catch(e){i(e)}}function s(t){try{l(r["throw"](t))}catch(e){i(e)}}function l(t){t.done?o(t.value):new n(function(e){e(t.value)}).then(a,s)}l((r=r.apply(t,e||[])).next())})},__generator=this&&this.__generator||function(t,e){function n(t){return function(e){return r([t,e])}}function r(n){if(o)throw new TypeError("Generator is already executing.");for(;l;)try{if(o=1,i&&(a=i[2&n[0]?"return":n[0]?"throw":"next"])&&!(a=a.call(i,n[1])).done)return a;switch(i=0,a&&(n=[0,a.value]),n[0]){case 0:case 1:a=n;break;case 4:return l.label++,{value:n[1],done:!1};case 5:l.label++,i=n[1],n=[0];continue;case 7:n=l.ops.pop(),l.trys.pop();continue;default:if(a=l.trys,!(a=a.length>0&&a[a.length-1])&&(6===n[0]||2===n[0])){l=0;continue}if(3===n[0]&&(!a||n[1]>a[0]&&n[1]<a[3])){l.label=n[1];break}if(6===n[0]&&l.label<a[1]){l.label=a[1],a=n;break}if(a&&l.label<a[2]){l.label=a[2],l.ops.push(n);break}a[2]&&l.ops.pop(),l.trys.pop();continue}n=e.call(t,l)}catch(r){n=[6,r],i=0}finally{o=a=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}var o,i,a,s,l={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return s={next:n(0),"throw":n(1),"return":n(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s},common;!function(t){function e(t){for(var e in t)delete t[e]}function n(t){var e=String(t),n=l[e];return n||(n=l[e]=r(t)),n}function r(t){var e=c[String(t)];if(e&&e.length>0){var n=e.pop();return n}var r=new t;return r._onClear(),r}function o(t,e){if((0>e||e!==e)&&(e=0),t){var n=String(t),r=c[n];u[n]=e,r&&r.length>e&&(r.length=e)}else{a=e;for(var n in c){var r=c[n];r.length>e&&(r.length=e),n in u&&(u[n]=e)}}}function i(t){if(t){var e=c[String(t)];e&&e.length&&(e.length=0)}else for(var n in c){var e=c[n];e.length=0}}var a=3e3,s=0,l={},u={},c={};t.clearMap=e,t.getInstance=n,t.create=r,t.setMaxCount=o,t.clear=i;var p=function(){function t(){this.hashCode=s++}return t.toString=function(){throw new Error},t.prototype.release=function(){this._onClear();var t=String(this.constructor),e=t in u?a:u[t],n=c[t]=c[t]||[];n.length<e&&(console.assert(n.indexOf(this)<0),n.push(this))},t.prototype.dispose=function(){this._onClear()},t}();t.BaseObject=p,__reflect(p.prototype,"common.BaseObject")}(common||(common={}));var common;!function(t){var e=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.data=null,e}return __extends(e,t),e.toString=function(){return"[class common.Event]"},e.prototype._onClear=function(){this.type="",this.target=null,this.currentTarget=null,this.data=null},e.prototype.copyFrom=function(t){return this.type=t.type,this.target=t.target,this.currentTarget=t.currentTarget,this.data=t.data,this},e}(t.BaseObject);t.Event=e,__reflect(e.prototype,"common.Event");var n=function(n){function r(){var t=null!==n&&n.apply(this,arguments)||this;return t._listenerBins={},t}return __extends(r,n),r.toString=function(){return"[class common.EventDispatcher]"},r.prototype._onClear=function(){this.enabled=!0,this._dipatchLevel=0,t.clearMap(this._listenerBins)},r.prototype._sortListeners=function(t,e){return t.priority>e.priority?1:-1},r.prototype._isSameListener=function(t,e){return t===e},r.prototype.hasEventListener=function(t){return t in this._listenerBins[t]},r.prototype.addEventListener=function(t,e,n,r,o){void 0===r&&(r=null),void 0===o&&(o=0),this.removeEventListener(t,e);var i=this._listenerBins[t];i?0!==this._dipatchLevel&&(this._listenerBins[t]=i=i.concat()):this._listenerBins[t]=i=[],i.push({listener:e,thisTarget:n,data:r,priority:o}),i.sort(this._sortListeners)},r.prototype.removeEventListener=function(t,e,n){void 0===n&&(n=null);var r=this._listenerBins[t];if(r){0!==this._dipatchLevel&&(this._listenerBins[t]=r=r.concat());for(var o=0,i=r.length;i>o;++o){var a=r[o];if(a.listener===e&&this._isSameListener(a.data,n)){r.splice(o,1);break}}}},r.prototype.removeEventListeners=function(t){if(t)delete this._listenerBins[t];else for(var e in this._listenerBins)delete this._listenerBins[e]},r.prototype.dispatchEvent=function(t){var e=t.type,n=this._listenerBins[e];if(n){t.target=this,t.currentTarget||(t.currentTarget=t.target),this._dipatchLevel++;for(var r=0,o=n;r<o.length;r++){var i=o[r];i.listener.call(i.thisTarget,t,i.data)}this._dipatchLevel--}},r.prototype.dispatchEventWith=function(n,r){if(this.enabled){var o=t.create(e);o.type=n,o.data=r,this.dispatchEvent(o),o.release()}},r}(t.BaseObject);t.EventDispatcher=n,__reflect(n.prototype,"common.EventDispatcher",["common.IEventDispatcher"])}(common||(common={}));var common;!function(t){function e(t,e){for(var n=0,r=e;n<r.length;n++){var o=r[n];if(o.component===t)return o}return null}t.getViewByComponent=e;var n=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.toString=function(){return"[class common.Notification]"},e.prototype._onClear=function(){this.type="",this.target=null,this.data=null},e}(t.BaseObject);t.Notification=n,__reflect(n.prototype,"common.Notification");var r=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype._onClear=function(){this._context=null},e.prototype.sendNotification=function(t,e){this._context.sendNotification(t,e,this)},Object.defineProperty(e.prototype,"controller",{get:function(){return this._context.controller},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"application",{get:function(){return this._context.application},enumerable:!0,configurable:!0}),e}(t.BaseObject);t.Model=r,__reflect(r.prototype,"common.Model");var o=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype._onClear=function(){t.prototype._onClear.call(this),this.model=null,this.component=null,this._context=null},e.prototype._notificationListenerHandler=function(t,e){e.call(this,t.data)},e.prototype.addNotification=function(t,e,n){void 0===n&&(n=1),this._context.addEventListener(t,this._notificationListenerHandler,this,e,n)},e.prototype.removeNotification=function(t,e){this._context.removeEventListener(t,this._notificationListenerHandler,e)},e.prototype.sendNotification=function(t,e){this._context.sendNotification(t,e,this)},e.prototype.initialize=function(t,e,n){this.model=t,this.component=e,this._onInitialize(n),this.update()},e.prototype.update=function(){},Object.defineProperty(e.prototype,"controller",{get:function(){return this._context.controller},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"application",{get:function(){return this._context.application},enumerable:!0,configurable:!0}),e}(t.EventDispatcher);t.View=o,__reflect(o.prototype,"common.View");var i=function(e){function r(){var t=null!==e&&e.apply(this,arguments)||this;return t.result=null,t}return __extends(r,e),r.prototype._onClear=function(){this.success=null,this.result=null,this._guard=null,this._hook=null},r.prototype.execute=function(e,r,o){return void 0===r&&(r=null),void 0===o&&(o=null),__awaiter(this,void 0,void 0,function(){return __generator(this,function(i){switch(i.label){case 0:return e instanceof n?this.notification=e:(this.notification=t.create(n),this.notification.data=e),this._guard=r,this._hook=o,null!==this._guard&&this._guard(this)===!1?[3,2]:[4,this._onExecute()];case 1:return i.sent(),null===this.success&&(this.success=!0),null!==this._hook&&this._hook(this),[3,3];case 2:this.success=!0,i.label=3;case 3:return[2,this.result]}})})},Object.defineProperty(r.prototype,"data",{get:function(){return this.notification.data},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"application",{get:function(){return this._context.application},enumerable:!0,configurable:!0}),r}(t.BaseObject);t.Command=i,__reflect(i.prototype,"common.Command");var a=function(e){function n(){var t=null!==e&&e.apply(this,arguments)||this;return t._commandBins=[],t}return __extends(n,e),n.prototype._onExecute=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this._next(this.notification.data)];case 1:return t.sent(),[2]}})})},n.prototype._next=function(e){return __awaiter(this,void 0,void 0,function(){var n;return __generator(this,function(r){switch(r.label){case 0:return this._commandBins.length>0?(n=this._commandBins.shift())?(this.notification.data=e,this._currentCommand=t.create(n.commandClass),[4,this._currentCommand.execute(this.notification,n.guard,n.hook)]):[3,4]:[3,5];case 1:return r.sent(),this._currentCommand.success?[4,this._next(this._currentCommand.result)]:[3,3];case 2:return r.sent(),[3,4];case 3:this._fail(this._currentCommand.result),r.label=4;case 4:return[3,6];case 5:this.result=this._currentCommand.result,r.label=6;case 6:return[2]}})})},n.prototype._fail=function(t){this.result=t},n.prototype.addCommand=function(t,e,n){void 0===e&&(e=null),void 0===n&&(n=null);var r={commandClass:t,guard:e,hook:n};this._commandBins.push(r)},n.prototype.insertCommand=function(t,e,n){void 0===e&&(e=null),void 0===n&&(n=null);var r={commandClass:t,guard:e,hook:n};this._commandBins.unshift(r)},n}(i);t.QueueCommand=a,__reflect(a.prototype,"common.QueueCommand");var s=function(e){function r(){var n=null!==e&&e.apply(this,arguments)||this;return n.controller=t.create(l),n._application=null,n}return __extends(r,e),r.toString=function(){return"[class common.Context]"},r.prototype.release=function(){throw new Error},r.prototype._isSameListener=function(t,n){return t&&t.commandClass&&n?t.commandClass===n:e.prototype._isSameListener.call(this,t,n)},r.prototype.initialize=function(t){this._application=t,this.controller._context=this},r.prototype.sendNotification=function(e,r,o){if(void 0===o&&(o=null),this.enabled){var i=t.create(n);i.type=e,i.target=o,i.data=r,this.dispatchEventWith(e,i),i.release()}},r.prototype.getInstance=function(e){var n=t.getInstance(e);return n._context=this,n},r.prototype.create=function(e){var n=t.create(e);return n._context=this,n},Object.defineProperty(r.prototype,"application",{get:function(){return this._application},enumerable:!0,configurable:!0}),r}(t.EventDispatcher);t.Context=s,__reflect(s.prototype,"common.Context");var l=function(e){function n(){return null!==e&&e.apply(this,arguments)||this}return __extends(n,e),n.toString=function(){return"[class common.Controller]"},n.prototype._notificationHandler=function(t,e){this.execute(e.commandClass,t.data,e.guard,e.hook)},n.prototype._onClear=function(){this._context=null},n.prototype.register=function(t,e,n,r){void 0===n&&(n=null),void 0===r&&(r=null);var o={commandClass:e,guard:n,hook:r};this._context.addEventListener(t,this._notificationHandler,this,o)},n.prototype.unregister=function(t,e){var n={commandClass:e,guard:null,hook:null};this._context.removeEventListener(t,this._notificationHandler,n)},n.prototype.execute=function(e,n,r,o){return void 0===r&&(r=null),void 0===o&&(o=null),__awaiter(this,void 0,void 0,function(){var i;return __generator(this,function(a){switch(a.label){case 0:return i=t.create(e),[4,i.execute(n,r,o)];case 1:return[2,a.sent()]}})})},n}(t.BaseObject);__reflect(l.prototype,"Controller")}(common||(common={}));var player;!function(t){t.NotificationType={VOChange:"VOChange",ArmatureAdd:"ArmatureAdd",ArmatureRemove:"ArmatureRemove",ArmatureChange:"ArmatureChange",ArmatureReplace:"ArmatureReplace",AnimationStart:"AnimationStart",AnimationComplete:"AnimationComplete",AnimationChange:"AnimationChange"};var e=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(common.Model);t.BaseModel=e,__reflect(e.prototype,"player.BaseModel");var n=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(common.View);t.BaseView=n,__reflect(n.prototype,"player.BaseView");var r=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(common.Command);t.BaseCommand=r,__reflect(r.prototype,"player.BaseCommand");var o=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.toString=function(){return"[class dragonBones.QueueCommand]"},e}(common.QueueCommand);t.QueueCommand=o,__reflect(o.prototype,"player.QueueCommand")}(player||(player={}));var player;!function(t){var e=function(e){function r(){var t=null!==e&&e.apply(this,arguments)||this;return t.armatures=[],t.factory=dragonBones.EgretFactory.factory,t._armature=null,t}return __extends(r,e),r.toString=function(){return"[class player.ApplicationModel]"},r.prototype.createArmature=function(e){var r=this.factory.buildArmatureDisplay(e.name,e.parent.name);if(r){var o=this._context.create(n);return o.initialize(null,r,null),this.armatures.push(o),this.sendNotification(t.NotificationType.ArmatureAdd,o),o}return null},r.prototype.removeArmature=function(e){this.armature===e&&(this.armature=null);var n=this.armatures.indexOf(e);console.assert(n>=0),this.armatures.splice(n,1),this.sendNotification(t.NotificationType.ArmatureRemove,e),e.release()},r.prototype.clearAllArmature=function(){for(var t=this.armatures.length;t--;){var e=this.armatures[t];this.removeArmature(e)}},r.prototype.replaceArmature=function(e){var n=this.armature,r=this.createArmature(e);n&&r&&(r.component.x=n.component.x,r.component.y=n.component.y),this.armature=r,this.sendNotification(t.NotificationType.ArmatureReplace,n),n&&this.removeArmature(n)},Object.defineProperty(r.prototype,"vo",{set:function(e){if(e){this.clearAllArmature(),this.factory.clear(!0);for(var n=0,r=e;n<r.length;n++){var o=r[n],i=this.factory.parseDragonBonesData(o.data);if(i)if(o.textureAtlasDatas.length>0)for(var a=0,s=0,l=o.textureAtlasDatas;s<l.length;s++){var u=l[s],c=o.textureAtlases[a];c?this.factory.parseTextureAtlasData(u,c):this.factory.parseTextureAtlasData(u,null)}else this.factory.updateTextureAtlasData(i.name,o.textureAtlases)}this.sendNotification(t.NotificationType.VOChange,null)}},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"armature",{get:function(){return this._armature},set:function(e){if(this._armature!==e){var n=this._armature;this._armature=e,this.sendNotification(t.NotificationType.ArmatureChange,n)}},enumerable:!0,configurable:!0}),r}(t.BaseModel);t.ApplicationModel=e,__reflect(e.prototype,"player.ApplicationModel");var n=function(e){function n(){return null!==e&&e.apply(this,arguments)||this}return __extends(n,e),n.toString=function(){return"[class player.ArmatureView]"},n.prototype._componentHandler=function(e){var n=e.eventObject;switch(e.type){case dragonBones.EventObject.FADE_IN:if(this._animation===n.animationState)return;var r=this._animation;this._animation=n.animationState,r&&this._animation&&r.name===this._animation.name||this.sendNotification(t.NotificationType.AnimationChange,r),this.sendNotification(t.NotificationType.AnimationStart,this._animation);break;case dragonBones.EventObject.COMPLETE:this.sendNotification(t.NotificationType.AnimationComplete,this._animation)}},n.prototype._onClear=function(){this.component&&(this.component.removeEvent(dragonBones.EventObject.FADE_IN,this._componentHandler,this),this.component.removeEvent(dragonBones.EventObject.COMPLETE,this._componentHandler,this),this.component.dispose(!0)),e.prototype._onClear.call(this),this._animation=null},n.prototype._onInitialize=function(t){this.component.addEvent(dragonBones.EventObject.FADE_IN,this._componentHandler,this),this.component.addEvent(dragonBones.EventObject.COMPLETE,this._componentHandler,this)},n.prototype.changeAnimation=function(t){var e=this.component.armature.armatureData.animationNames;t%=e.length,0>t&&(t=e.length+t),this.component.animation.fadeIn(e[t])},n.prototype.playAnimation=function(t){void 0===t&&(t=null),t?this.component.animation.fadeIn(t):!this.component.animation.lastAnimationState||this.component.animation.lastAnimationState.isCompleted?this.component.animation.play():this.component.animation.lastAnimationState.play()},n.prototype.stopAnimation=function(){this.component.animation.lastAnimationState&&this.component.animation.lastAnimationState.stop()},n.prototype.prevAnimation=function(){if(this._animation){var t=this.component.armature.armatureData.animationNames;this.changeAnimation(t.indexOf(this._animation.name)-1)}else this.playAnimation()},n.prototype.nextAnimation=function(){if(this._animation){var t=this.component.armature.armatureData.animationNames;this.changeAnimation(t.indexOf(this._animation.name)+1)}else this.playAnimation()},Object.defineProperty(n.prototype,"animation",{get:function(){return this._animation},enumerable:!0,configurable:!0}),n}(t.BaseView);t.ArmatureView=n,__reflect(n.prototype,"player.ArmatureView")}(player||(player={}));var Main=function(t){function e(){var e=t.call(this)||this;return e.armatureContainer=new egret.DisplayObjectContainer,e._context=common.create(common.Context),e.addChild(e.armatureContainer),e.addEventListener(egret.Event.ADDED_TO_STAGE,function(){var t=e._context.getInstance(player.Application),n=e._context.getInstance(player.ApplicationModel);if(e._context.initialize(t),t.queryConfig=player.getQueryConfig(window.location.search),t.initialize(n,e,null),t.queryConfig&&t.queryConfig.sources)t.controller.execute(player.LoadRemoteFiles,t.queryConfig).then(function(e){t.model.vo=e});else{var r=document.getElementById("data");r&&t.controller.execute(player.LoadInlineFiles,r.innerHTML).then(function(e){t.model.vo=e})}t.queryConfig&&t.queryConfig.scaleMode&&(t.component.stage.scaleMode=t.queryConfig.scaleMode)},e),e}return __extends(e,t),e}(egret.DisplayObjectContainer);__reflect(Main.prototype,"Main");var player;!function(t){var e=function(e){function n(){var t=null!==e&&e.apply(this,arguments)||this;return t.queryConfig=null,t}return __extends(n,e),n.toString=function(){return"[class player.Application]"},n.prototype._notificationHandler=function(e){switch(e.type){case t.NotificationType.VOChange:for(var n in this.model.factory.getAllDragonBonesData()){var r=this.model.factory.getDragonBonesData(n);if(r&&r.armatureNames.length>0){var o=null;o=r.stage?r.stage:r.getArmature(r.armatureNames[0]),o&&(this.model.armature=this.model.createArmature(o));break}}break;case t.NotificationType.ArmatureAdd:var i=e.data;i&&this.component.armatureContainer.addChild(i.component);break;case t.NotificationType.ArmatureRemove:var i=e.data;i&&this.component.armatureContainer.removeChild(i.component);break;case t.NotificationType.ArmatureChange:var i=this.model.armature;if(i){var o=i.component.armature.armatureData;if(o.canvas){if(this.component.stage.setContentSize(o.canvas.width,o.canvas.height),i.component.x=-o.canvas.x,i.component.y=-o.canvas.y,o.canvas.hasBackground){var a=document.getElementById("dragonBonesPlayer");a&&(a.style.backgroundColor="#"+o.canvas.color.toString(16))}}else this.component.stage.setContentSize(o.aabb.width,o.aabb.height),i.component.x=-(.5*o.aabb.width+o.aabb.x),i.component.y=-(.5*o.aabb.height+o.aabb.y);i.playAnimation()}break;case t.NotificationType.AnimationComplete:var i=this.model.armature;if(i&&i.animation){var s=i.component.armature.armatureData.animationNames;s.indexOf(i.animation.name)<s.length-1&&i.nextAnimation()}}},n.prototype._componentHandler=function(t){switch(t.type){case egret.Event.RESIZE:this.component.armatureContainer.x=.5*this.component.stage.stageWidth,this.component.armatureContainer.y=.5*this.component.stage.stageHeight;break;case egret.TouchEvent.TOUCH_END:var e=this.model.armature;e&&e.animation&&0===e.animation.playTimes&&e.nextAnimation()}},n.prototype._documentHandler=function(e){var n=this;switch(e.type){case"dragenter":case"dragover":e.stopPropagation(),e.preventDefault();break;case"drop":var r=e.dataTransfer;r&&r.files&&this.controller.execute(t.LoadLocalFiles,r.files).then(function(t){n.model.vo=t}),e.stopPropagation(),e.preventDefault()}},n.prototype._onInitialize=function(){if(console.log("DragonBones Player: 0.0.4"),this.addNotification(t.NotificationType.VOChange,this._notificationHandler),this.addNotification(t.NotificationType.ArmatureAdd,this._notificationHandler),this.addNotification(t.NotificationType.ArmatureRemove,this._notificationHandler),this.addNotification(t.NotificationType.ArmatureChange,this._notificationHandler),this.addNotification(t.NotificationType.AnimationComplete,this._notificationHandler),this.component.stage.addEventListener(egret.Event.RESIZE,this._componentHandler,this),this.component.stage.addEventListener(egret.TouchEvent.TOUCH_END,this._componentHandler,this),!egret.Capabilities.isMobile){var e=document.body;e.addEventListener("dragenter",this._documentHandler),e.addEventListener("dragover",this._documentHandler),e.addEventListener("drop",this._documentHandler)}},n}(t.BaseView);t.Application=e,__reflect(e.prototype,"player.Application")}(player||(player={}));var player;!function(t){var e=function(e){function n(){return null!==e&&e.apply(this,arguments)||this}return __extends(n,e),n.toString=function(){return"[class player.loadInlineFiles]"},n.prototype._onExecute=function(){return __awaiter(this,void 0,void 0,function(){var e=this;return __generator(this,function(n){return this.result=[],[2,new Promise(function(n){for(var r=0,o=JSON.parse(e.data),i=0,a=o;i<a.length;i++){var s=a[i],l={data:t.base64ToArrayBuffer(s.data),textureAtlasDatas:[],textureAtlases:[]};r+=s.textureAtlases.length;for(var u=0,c=s.textureAtlases;u<c.length;u++){var p=c[u],h=document.createElement("img");l.textureAtlases.push(h),h.onload=function(){r--,0>=r&&n()},h.src="data:image/png;base64,"+p}e.result.push(l)}})]})})},n}(t.BaseCommand);t.LoadInlineFiles=e,__reflect(e.prototype,"player.LoadInlineFiles")}(player||(player={}));var player;!function(t){var e=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._loadCount=0,e._dragonBonesConfigs={},e._textureAtlasConfigs={},e._textureAtlasTextures={},e}return __extends(e,t),e.toString=function(){return"[class player.LoadLocalFiles]"},e.prototype._onExecute=function(){return __awaiter(this,void 0,void 0,function(){var t=this;return __generator(this,function(e){return this.result=[],[2,new Promise(function(e){for(var n=function(e){var o=e.target;switch(e.type){case"load":var i=o.file,a=o.result,s=i.baseName;"image/png"===i.type?(s=i.baseName=t._modifyName(i.name),t._textureAtlasTextures[s]=i,console.log("Load complete:",i.type,i.name),o.removeEventListener("load",n),o.removeEventListener("error",n),t._loadCount--,0===t._loadCount&&r()):s?(console.log("Load complete:",i.type,i.name),o.removeEventListener("load",n),o.removeEventListener("error",n),t._loadCount--,0===t._loadCount&&r()):(s=i.baseName=t._modifyName(i.name),0===a.indexOf("DBDT")?(t._dragonBonesConfigs[s]=i,o.readAsArrayBuffer(i),console.log("Load:",i.type,i.name)):a.indexOf("armature")>0||a.indexOf("textureAtlas")>0?(t._dragonBonesConfigs[s]=i,o.readAsText(i),console.log("Load:",i.type,i.name)):a.indexOf("SubTexture")>0?(t._textureAtlasConfigs[s]=i,o.readAsText(i),console.log("Load:",i.type,i.name)):(o.removeEventListener("load",n),o.removeEventListener("error",n),t._loadCount--,0===t._loadCount&&r()));break;default:o.removeEventListener("load",n),o.removeEventListener("error",n),t._loadCount--,0===t._loadCount&&r()}},r=(function(){var n=0;for(var r in t._dragonBonesConfigs){for(var o=t._dragonBonesConfigs[r],i=o.loader,a="string"==typeof i.result?JSON.parse(i.result):i.result,s={data:a,textureAtlasDatas:[],textureAtlases:[]},l=r.split(".").shift(),u=t._getTextureAtlases(l),c=0,p=u;c<p.length;c++){var h=p[c],f=h.loader,d=h.baseName.split(".").shift()+".png",m=JSON.parse(f.result);if(d in t._textureAtlasTextures){var _=t._textureAtlasTextures[d],y=_.loader,g=document.createElement("img");g.src=y.result,g.onload=function(){n--,0===n&&e()},n++,s.textureAtlasDatas.push(m),s.textureAtlases.push(g)}else s.textureAtlasDatas.push(m),s.textureAtlases.push(null)}t.result.push(s)}0===n&&e()}),o=0,i=t.data.length;i>o;++o){var a=t.data[o],s=new FileReader;switch(a.loader=s,s.file=a,s.addEventListener("load",n),s.addEventListener("error",n),t._loadCount++,a.type){case"image/png":s.readAsDataURL(a),console.log("Load:",a.type,a.name);break;default:s.readAsText(a.slice(0,Math.min(200,a.size)))}}})]})})},e.prototype._modifyName=function(t){return t.indexOf("_ske.")>0?t=t.replace("_ske.","."):t.indexOf("_tex.")>0?t=t.replace("_tex.","_texture."):t.indexOf("_tex_")>0&&(t=t.replace("_tex_","_texture_")),t},e.prototype._getTextureAtlases=function(t,e,n){void 0===e&&(e=null),void 0===n&&(n="texture");var r=0,o=null!==e?e:t,i=(o.length>0?o+(n?"_"+n:n):n)+".json",a=new Array;if(i in this._textureAtlasConfigs)return a.push(this._textureAtlasConfigs[i]),a;for(;;){if(o.length>0&&n.length>0)i=o+"_"+n+"_"+r++ +".json";else if(n.length>0)i=n+"_"+r++ +".json";else{if(!(o.length>0)){console.assert(!1);break}i=o+"_"+r++ +".json"}if(i in this._textureAtlasConfigs)a.push(this._textureAtlasConfigs[i]);else if(r>1)break}if(a.length>0||null!==e)return a;if(a=this._getTextureAtlases(t,"",n),a.length>0)return a;if(r=t.lastIndexOf("_"),r>=0){if(e=t.substring(0,r),a=this._getTextureAtlases(t,e,n),a.length>0)return a;if(a=this._getTextureAtlases(t,e,""),a.length>0)return a}return"atlas"!==n&&(a=this._getTextureAtlases(t,null,"atlas")),a},e}(t.BaseCommand);t.LoadLocalFiles=e,__reflect(e.prototype,"player.LoadLocalFiles")}(player||(player={}));var player;!function(t){var e=function(e){function n(){return null!==e&&e.apply(this,arguments)||this}return __extends(n,e),n.toString=function(){return"[class player.LoadRemoteFiles]"},n.prototype._onExecute=function(){return __awaiter(this,void 0,void 0,function(){var e=this;return __generator(this,function(n){return this.result=[],[2,new Promise(function(n){if(e.data.sources&&e.data.sources instanceof Array){var r,o=e.data.sources,i=null,a=new XMLHttpRequest,s=function(){if(i){if(null===r.data)a.response instanceof ArrayBuffer?r.data=a.response:r.data=JSON.parse(a.response);else if(r.textureAtlasDatas.length===r.textureAtlases.length)r.textureAtlasDatas.push(JSON.parse(a.response));else{var e=document.createElement("img");if(e.src="data:image/png;base64,"+t.arrayBufferToBase64(a.response),r.textureAtlases.push(e),r.textureAtlases.length===i.textureAtlases.length)return void l()}if(r.textureAtlasDatas.length===r.textureAtlases.length){var n=i.root+i.textureAtlasDatas[r.textureAtlasDatas.length];n?(a.open("GET",n,!0),a.responseType="text",a.send()):r.textureAtlasDatas.push("")}else{var n=i.root+i.textureAtlases[r.textureAtlases.length];n?(a.open("GET",n,!0),a.responseType="arraybuffer",a.send()):r.textureAtlases.push(null)}}},l=function(){return 0===o.length?void n():(i=o.pop(),void(i?(i.root=i.root||"",r={data:null,textureAtlasDatas:[],textureAtlases:[]},e.result.push(r),a.open("GET",i.root+i.data,!0),i.data.indexOf(".json")<0?a.responseType="arraybuffer":a.responseType="text",a.send()):l()))};a.addEventListener("loadend",s),l()}})]})})},n}(t.BaseCommand);t.LoadRemoteFiles=e,__reflect(e.prototype,"player.LoadRemoteFiles")}(player||(player={}));var common;!function(t){t.EventType={HistoryState:"HistoryState",HistoryAdd:"HistoryAdd",HistoryFree:"HistoryFree"};var e=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype._onClear=function(){this.data=null,this._isDone=!1},e.prototype.undo=function(){return this._isDone?(this._isDone=!1,!0):!1},e.prototype.redo=function(){return this._isDone?!1:(this._isDone=!0,!0)},e}(t.BaseObject);t.BaseState=e,__reflect(e.prototype,"common.BaseState",["common.IState"]);var n=function(e){function n(){var t=null!==e&&e.apply(this,arguments)||this;return t._states=[],t._batchs=[],t}return __extends(n,e),n.toString=function(){return"[class common.History]"},n.prototype._onClear=function(){e.prototype._onClear.call(this);for(var t=0,n=this._states;t<n.length;t++){var r=n[t];r.release()}for(var o=0,i=this._batchs;o<i.length;o++){var a=i[o];a.release()}this.dispatcher=null,this._locked=0,this._index=-1,this._states.length=0,this._batchs.length=0},n.prototype._free=function(){this._states.length>this._index+1&&(this._states.length=this._index+1,null!==this.dispatcher&&this.dispatcher.dispatchEventWith(t.EventType.HistoryFree,null))},n.prototype._doState=function(e,n){if(n?e.undo():e.redo(),null!==this.dispatcher&&e.data){var r={isUndo:n,data:e.data};this.dispatcher.dispatchEventWith(t.EventType.HistoryState,r)}},n.prototype._getStateByObject=function(t,e,o,i){void 0===i&&(i=null);for(var a=t._states.length;a--;){var s=t._states[a];if(s instanceof r){if((null===i||s!==i)&&s.object===e&&s.key===o)return s}else if(s instanceof n){var l=this._getStateByObject(s,e,o,i);if(null!==l)return l}}return null},n.prototype.undo=function(){return this._batchs.length>0?!1:this.go(-1)},n.prototype.redo=function(){return this._batchs.length>0?!1:this.go(this._states.length-1)},n.prototype.back=function(){return this._index<0?!1:this._batchs.length>0?!1:(this._locked|=1,this._doState(this._states[this._index--],!0),this._locked&=2,!0)},n.prototype.forward=function(){return this._index>=this._states.length-1?!1:this._batchs.length>0?!1:(this._locked|=1,this._doState(this._states[++this._index],!1),this._locked&=2,!0)},n.prototype.go=function(t){if(this._batchs.length>0)return!1;var e=!1;if(this._index<t)for(;this._index!==t&&this.forward();)e=!0;else for(;this._index!==t&&this.back();)e=!0;return e},n.prototype.add=function(e){if(0===this._locked)if(this._batchs.length>0){var n=this._batchs[this._batchs.length-1];n.add(e)}else this._states[this._index+1]=e,null!==this.dispatcher&&this.dispatcher.dispatchEventWith(t.EventType.HistoryAdd,e),this.forward(),this._free()},n.prototype.addBatch=function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];if(0!==this._locked)return null;var o=t.create(n);o.dispatcher=this.dispatcher;for(var i=0,a=e;i<a.length;i++){var s=a[i];o.add(s)}return this.add(o),o},n.prototype.beginBatch=function(){var e=t.create(n);return e.dispatcher=this.dispatcher,this._batchs.push(e),e},n.prototype.endBatch=function(t){if(void 0===t&&(t=null),!(this._batchs.length<1)){var e=this._batchs.pop();e.count<1||(e.data=t,e._locked|=2,this._batchs.length>0?this._batchs[this._batchs.length-1].add(e):this.add(e))}},n.prototype.linkObjectState=function(t,e){var n=this._getStateByObject(this,t,e);if(null!==n){var r=this._getStateByObject(this,t,e,n);null!==r&&(n.fromValue=r.toValue)}},n.prototype.getState=function(t){return this._states[t]},Object.defineProperty(n.prototype,"enabled",{get:function(){return 0===this._locked},set:function(t){t?this._locked&=2:this._locked|=1},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"index",{get:function(){return this._index},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"count",{get:function(){return this._states.length},enumerable:!0,configurable:!0}),n}(e);t.History=n,__reflect(n.prototype,"common.History");var r=function(e){function n(){return null!==e&&e.apply(this,arguments)||this}return __extends(n,e),n.toString=function(){return"[class common.ModifyObjectState]"},n.create=function(e,r,o,i){void 0===i&&(i=null);var a=r in e?e[r]:void 0;if(a===o)return null;var s=t.create(n);return s.object=e,s.key=r,s.data=i,s.fromValue=a,s.toValue=o,s},n.prototype._onClear=function(){e.prototype._onClear.call(this),this.object=null,this.key="",this.fromValue=null,this.toValue=null},n.prototype.undo=function(){return e.prototype.undo.call(this)?(void 0!==this.fromValue?this.object[this.key]=this.fromValue:delete this.object[this.key],!0):!1},n.prototype.redo=function(){return e.prototype.redo.call(this)?(void 0!==this.toValue?this.object[this.key]=this.toValue:delete this.object[this.key],!0):!1
},n}(e);t.ModifyObjectState=r,__reflect(r.prototype,"common.ModifyObjectState");var o=function(e){function n(){return null!==e&&e.apply(this,arguments)||this}return __extends(n,e),n.toString=function(){return"[class common.ModifyArrayState]"},n.create=function(e,r,o,i){void 0===i&&(i=null),0>r&&(r=e.length>0?e.length-1:0);var a=t.create(n);return a.array=e,a.index=r,a.data=i,o?a.toValue=o:a.fromValue=a.array[a.index],a},n.prototype._onClear=function(){e.prototype._onClear.call(this),this.array=null,this.index=-1,this.fromValue=null,this.toValue=null},n.prototype.undo=function(){return e.prototype.undo.call(this)?(this.fromValue?this.array.splice(this.index,0,this.fromValue):this.array.splice(this.index,1),!0):!1},n.prototype.redo=function(){return e.prototype.redo.call(this)?(this.toValue?this.array.splice(this.index,0,this.toValue):this.array.splice(this.index,1),!0):!1},n}(e);t.ModifyArrayState=o,__reflect(o.prototype,"common.ModifyArrayState")}(common||(common={}));var player;!function(t){function e(t){if(t.indexOf("?")>=0){for(var e={},n=void 0,r=/\+/g,o=/([^&=]+)=?([^&]*)/g,i=function(t){return decodeURIComponent(t.replace(r," "))},a=t.substring(1);n=o.exec(a);){var s=i(n[2]),l=Number(s);l===l?e[i(n[1])]=l:e[i(n[1])]=s}return e.sources&&"string"==typeof e.sources&&(e.sources=JSON.parse(e.sources)),e.armature&&"string"==typeof e.armature&&e.armature.indexOf(",")>0&&(e.armature=e.armature.split(",")),e.skin&&"string"==typeof e.skin&&e.skin.indexOf(",")>0&&(e.skin=e.skin.split(",")),e}return null}function n(t){for(var e=window.atob(t),n=e.length,r=new Uint8Array(n),o=0;n>o;++o)r[o]=e.charCodeAt(o);return r.buffer}function r(t){for(var e="",n=new Uint8Array(t),r=n.byteLength,o=0;r>o;o++)e+=String.fromCharCode(n[o]);return window.btoa(e)}t.getQueryConfig=e,t.base64ToArrayBuffer=n,t.arrayBufferToBase64=r}(player||(player={}));